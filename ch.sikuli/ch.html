
<html>
   <head>
      <style type="text/css">
         .sikuli-code {
            font-size: 20px;
            font-family: "Osaka-mono", Monospace;
            line-height: 1.5em;
            display:table-cell;
            white-space: pre-wrap;       /* css-3 */
            white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
            width: 99%;   /* remove horizontal scroll-bar when viewing in IE7 */
         }
         .sikuli-code img {
            vertical-align: middle;
            margin: 2px;
            border: 1px solid #ccc;
            padding: 2px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            -moz-box-shadow: 1px 1px 1px gray;
            -webkit-box-shadow: 1px 1px 2px gray;
         }
         .kw {
            color: blue;
         }
         .skw {
            color: rgb(63, 127, 127);
         }

         .str {
            color: rgb(128, 0, 0);
         }

         .dig {
            color: rgb(128, 64, 0);
         }

         .cmt {
            color: rgb(200, 0, 200);
         }

         h2 {
            display: inline;
            font-weight: normal;
         }

         .info {
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 20px;
            display: none;
         }

         a {
            color: #9D2900;
         }

         body {
            font-family: "Trebuchet MS", Arial, Sans-Serif;
         }

      </style>
   </head>
<body>
<div class="info">
<h2>ch.sikuli</h2> <a href="ch.zip">(Download this script)</a>
</div>
<pre class="sikuli-code">
<span class="kw">import</span> time
<span class="kw">import</span> json
<span class="kw">import</span> base64
<span class="kw">import</span> sys

HIGHLIGHTS = False
SAVEPATH = <span class="str">"d:\\ch\\"</span>
LOGFILEPATH = <span class="str">"d:\\ch\\ch.log"</span>
LEVELSKIP = <span class="dig">10</span>
SAVEGAME = True
EXITASCEND = False

SAMURAI = <span class="dig">3200</span>
MAXZONE = <span class="dig">2010</span>

<span class="cmt">###############</span>

heroes = [<span class="str">"Cid"</span>, <span class="str">"Treebeast"</span>, <span class="str">"Ivan"</span>, <span class="str">"Brittany"</span>, <span class="str">"Fisherman"</span>, <span class="str">"Betty"</span>, <span class="str">"Samurai"</span>, <span class="str">"Leon"</span>, <span class="str">"Seer"</span>, <span class="str">"Alexa"</span>,
    <span class="str">"Natalia"</span>, <span class="str">"Mercedes"</span>, <span class="str">"Bobby"</span>, <span class="str">"Broyle"</span>, <span class="str">"George"</span>, <span class="str">"Midas"</span>, <span class="str">"ReferiJerator"</span>, <span class="str">"Abaddon"</span>,<span class="str">"MaZhu"</span>,
    <span class="str">"Amenhotep"</span>,<span class="str">"Beastlord"</span>,<span class="str">"Athena"</span>,<span class="str">"Aphrodite"</span>,<span class="str">"Shinatobe"</span>,<span class="str">"Grant"</span>,<span class="str">"Frostleaf"</span>,<span class="str">"DreadKnight"</span>,<span class="str">"Atlas"</span>,
    <span class="str">"Terra"</span>,<span class="str">"Phthalo"</span>,<span class="str">"Orntchya"</span>,<span class="str">"Lilin"</span>,<span class="str">"Cadmia"</span>,<span class="str">"Alabaster"</span>,<span class="str">"Astraea"</span>]

heroidx = dict(map(<span class="kw">lambda</span> x: (heroes[x], x+<span class="dig">1</span>), range(len(heroes))))
heroname = dict(map(<span class="kw">lambda</span> x: (x+<span class="dig">1</span>, heroes[x]), range(len(heroes))))

state = {}

<span class="kw">def</span> resetstate():
    <span class="kw">global</span> state
    state = {
        <span class="str">'ascendNow'</span>: False,
        <span class="str">'ascendSoon'</span>: False,
        <span class="str">'besthero'</span>: False,
        <span class="str">'level'</span>: <span class="dig">0</span>,
        <span class="str">'hired'</span>: <span class="dig">0</span>,
        <span class="str">'starttime'</span>: time.time(),
        <span class="str">'wait'</span>: False,
        <span class="str">'primalSouls'</span>: <span class="dig">0</span>,
        <span class="str">'primalSoulsStart'</span>: <span class="dig">0</span>,
        <span class="str">'samurai'</span>: <span class="dig">0</span>,
        <span class="str">'gold'</span>: <span class="dig">0</span>,
        <span class="str">'maxgildidx'</span>: <span class="dig">0</span>,
        <span class="str">'gild1level'</span>: <span class="dig">0</span>,
        <span class="str">'gild2level'</span>: <span class="dig">0</span>,

        <span class="str">'highestFinishedZone'</span>: <span class="dig">0</span>,
        <span class="str">'rubies'</span>: <span class="dig">0</span>,
        <span class="str">'totalHeroSouls'</span>: <span class="dig">0</span>,
        <span class="str">'currentZoneHeight'</span>: <span class="dig">0</span>,
        <span class="str">'gold'</span>: <span class="dig">0</span>
    }

<span class="kw">def</span> timediff(start, end=None):
    <span class="kw">if</span> <span class="kw">not</span> end:
        end = time.time()
    diff = end - start
    <span class="kw">return</span> (<span class="str">"%02d:%02d:%02d.%04d"</span> % (diff / <span class="dig">3600</span>, (diff % <span class="dig">3600</span> / <span class="dig">60</span>), diff % <span class="dig">60</span>, (diff % <span class="dig">60</span> - int(diff % <span class="dig">60</span>)) * <span class="dig">10000</span>), diff)

<span class="kw">def</span> clickleft(n):
    <span class="kw">for</span> x <span class="kw">in</span> range(n):
        mouseDown(Button.LEFT)
        mouseUp()

<span class="kw">def</span> clickn(what=None, n=<span class="dig">1</span>, mod=<span class="dig">0</span>):
    <span class="kw">if</span> what:
        hover(what)
    <span class="kw">else</span>:
        hover(getLastMatch())
    clickleft(n)

<span class="kw">def</span> zclick(thing, count):
    hover(thing)
    keyDown(<span class="str">'z'</span>)
    <span class="skw">wait</span>(<span class="dig">0.05</span>)
    clickleft(count)
    <span class="skw">wait</span>(<span class="dig">0.05</span>)
    keyUp(<span class="str">'z'</span>)
    <span class="skw">wait</span>(<span class="dig">0.1</span>)
    <span class="kw">return</span> True

<span class="cmt"># find fish</span>
<span class="kw">def</span> fish():
    <span class="kw">if</span> exists(Pattern(<img src="1439028358739.png" />).similar(<span class="dig">0.85</span>),<span class="dig">0</span>):
        <span class="kw">if</span> <span class="kw">not</span> state[<span class="str">"ascendSoon"</span>]:
            <span class="skw">click</span>()
            Debug.user(<span class="str">"fish"</span>)
        <span class="kw">else</span>:
            Debug.user(<span class="str">"ascending soon, saving fish"</span>)
        <span class="kw">return</span> True
    <span class="kw">return</span> False

<span class="kw">def</span> rest(delay=<span class="dig">0.1</span>):
    fish()
    <span class="kw">if</span> exists(<img src="1439022623124.png" />):
        hover(<img src="1439022623124.png" />)
    <span class="skw">wait</span>(delay)

<span class="kw">def</span> decodeSave(dat):
    ANTI_CHEAT_CODE = <span class="str">"Fe12NAfA3R6z4k0z"</span>

    first,rest = dat.split(ANTI_CHEAT_CODE,<span class="dig">1</span>)

    txt=<span class="str">""</span>
    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="dig">0</span>, len(first), <span class="dig">2</span>):
      txt += first[i]

    base64.b64decode(txt)

    savegame = json.loads(base64.b64decode(txt))
    <span class="kw">return</span> json.loads(base64.b64decode(txt))

<span class="kw">def</span> checkrelics(save):
    found = False
    equip = {}
    minprimal = <span class="dig">99</span>

    <span class="kw">for</span> x <span class="kw">in</span> save[<span class="str">'items'</span>][<span class="str">'slots'</span>].keys():
        equip[save[<span class="str">'items'</span>][<span class="str">'slots'</span>][x]] = int(x)

    <span class="kw">for</span> k,v <span class="kw">in</span> save[<span class="str">'items'</span>][<span class="str">'items'</span>].items():
        <span class="kw">for</span> x <span class="kw">in</span> range(<span class="dig">1</span>,<span class="dig">5</span>):
            <span class="kw">if</span> equip[int(k)] &lt;= save[<span class="str">'items'</span>][<span class="str">'equipmentSlots'</span>]:
                bt = <span class="str">'bonusType%d'</span>%(x)
                bv = <span class="str">'bonus%dLevel'</span>%(x)
                <span class="kw">if</span> v[bt] == <span class="dig">17</span>:
                    <span class="kw">if</span> v[bv] &lt; minprimal:
                        minprimal = v[bv]

    <span class="kw">for</span> k,v <span class="kw">in</span> save[<span class="str">'items'</span>][<span class="str">'items'</span>].items():
        <span class="kw">if</span> equip[int(k)] &gt; save[<span class="str">'items'</span>][<span class="str">'equipmentSlots'</span>]:
            Debug.user(<span class="str">"relic: %s %s minprimal %d"</span> % (k, v, minprimal))
            <span class="kw">for</span> x <span class="kw">in</span> range(<span class="dig">1</span>,<span class="dig">5</span>):
                bt = <span class="str">'bonusType%d'</span>%(x)
                bv = <span class="str">'bonus%dLevel'</span>%(x)
                <span class="kw">if</span> v[bt] == <span class="dig">17</span>:
                    <span class="kw">if</span> v[bv] &gt;= minprimal:
                        found = True

    <span class="kw">return</span> found

<span class="kw">def</span> updateFromSave():
    savedata = saveGame(savefile=False)
    save = decodeSave(savedata)

    state[<span class="str">"samurai"</span>] = save[<span class="str">"heroCollection"</span>][<span class="str">"heroes"</span>][unicode(heroidx[<span class="str">"Samurai"</span>])][<span class="str">"level"</span>]


    maxGildIdx = <span class="dig">0</span>
    maxGild = <span class="dig">0</span>
    hired = <span class="dig">0</span>

    <span class="kw">for</span> idx, hero <span class="kw">in</span> save[<span class="str">"heroCollection"</span>][<span class="str">"heroes"</span>].items():
        <span class="kw">if</span> hero[<span class="str">"level"</span>] &gt; <span class="dig">0</span>:
            hired += <span class="dig">1</span>
        <span class="kw">if</span> hero[<span class="str">"epicLevel"</span>] &gt; maxGild:
            maxGild = hero[<span class="str">"epicLevel"</span>]
            maxGildIdx = hero[<span class="str">"id"</span>]

    state[<span class="str">"hired"</span>] = hired
    state[<span class="str">"maxgildidx"</span>] = maxGildIdx

    state[<span class="str">"gild1level"</span>] = save[<span class="str">"heroCollection"</span>][<span class="str">"heroes"</span>][unicode(maxGildIdx)][<span class="str">"level"</span>]
    state[<span class="str">"gild2level"</span>] = save[<span class="str">"heroCollection"</span>][<span class="str">"heroes"</span>][unicode(maxGildIdx - <span class="dig">1</span>)][<span class="str">"level"</span>]

    Debug.user(<span class="str">"maxGild: %d %d %s %d"</span> %(maxGild, maxGildIdx, heroname[maxGildIdx], state[<span class="str">"gild1level"</span>]))

    <span class="kw">for</span> k <span class="kw">in</span> [<span class="str">"primalSouls"</span>, <span class="str">"highestFinishedZone"</span>, <span class="str">"rubies"</span>, <span class="str">"totalHeroSouls"</span>, <span class="str">"currentZoneHeight"</span>,
        <span class="str">"gold"</span>]:
        state[k] = save[k]
        Debug.user(<span class="str">"%s: %s"</span>%(k, save[k]))

    <span class="kw">return</span> save

<span class="kw">def</span> saveGame(savefile=True):
    <span class="kw">if</span> <span class="kw">not</span> SAVEGAME:
        savefile = False

    <span class="kw">if</span> exists(Pattern(<img src="1439437506317.png" />).similar(<span class="dig">0.90</span>)):
        <span class="skw">click</span>()
        <span class="kw">if</span> exists(Pattern(<img src="1439437547153.png" />).similar(<span class="dig">0.80</span>)):
            <span class="skw">click</span>()
            <span class="skw">wait</span>(<span class="dig">0.5</span>)
            <span class="kw">if</span> savefile:
                timestr = time.strftime(<span class="str">"%Y_%m_%d_%H_%M_%S"</span>)
                <span class="skw">type</span>(SAVEPATH + timestr)
                <span class="skw">wait</span>(<span class="dig">0.5</span>)
                keyDown(Key.ENTER)
                <span class="skw">wait</span>(<span class="dig">0.05</span>)
                keyUp(Key.ENTER)
                <span class="skw">wait</span>(<span class="dig">1</span>)
            <span class="kw">else</span>:
                keyDown(Key.ESC)
                <span class="skw">wait</span>(<span class="dig">0.05</span>)
                keyUp(Key.ESC)
                <span class="skw">wait</span>(<span class="dig">1</span>)

            <span class="kw">if</span> exists(Pattern(<img src="1439437994711.png" />).similar(<span class="dig">0.80</span>), <span class="dig">1</span>):
                <span class="skw">click</span>()

    <span class="kw">return</span> Env.getClipboard()

<span class="kw">def</span> findDown(thing, func, args=[]):
    <span class="kw">while</span> <span class="kw">not</span> exists(thing, <span class="dig">0.1</span>):
        <span class="cmt"># find scrollbar</span>
        <span class="kw">if</span> exists(Pattern(<img src="1439062815605.png" />).similar(<span class="dig">0.86</span>), <span class="dig">0</span>):
            <span class="cmt"># scroll down</span>
            clickn(Pattern(<img src="1439062815605.png" />).similar(<span class="dig">0.77</span>).targetOffset(<span class="dig">0</span>,<span class="dig">2</span>), <span class="dig">4</span>)

        <span class="kw">if</span> buyUpgrades():
            <span class="kw">break</span>

        rest()

    <span class="kw">if</span> exists(thing, <span class="dig">0.1</span>):
        <span class="kw">return</span> func(thing, *args)
    <span class="kw">else</span>:
        <span class="kw">return</span> False

<span class="cmt"># scroll to bottom of hero list</span>
<span class="cmt"># check for target</span>
<span class="cmt"># if it exists, call func against it</span>
<span class="kw">def</span> findUp(thing, func, args=[]):
    scrollBottom()

    <span class="kw">while</span> <span class="kw">not</span> exists(thing, <span class="dig">0</span>):
        <span class="cmt"># scroll up button</span>
        <span class="kw">if</span> exists(Pattern(<img src="1439036427073.png" />).similar(<span class="dig">0.83</span>),<span class="dig">0</span>):
            clickn(Pattern(<img src="1439036427073.png" />).similar(<span class="dig">0.83</span>), <span class="dig">4</span>)

        <span class="cmt"># scrolled to top</span>
        <span class="kw">if</span> exists(Pattern(<img src="1439025863027.png" />).similar(<span class="dig">0.83</span>),<span class="dig">0</span>):
            <span class="kw">break</span>

    <span class="kw">if</span> exists(thing, <span class="dig">0</span>):
        <span class="kw">return</span> func(thing, *args)
    <span class="kw">else</span>:
        <span class="kw">return</span> False

<span class="kw">def</span> progressMode():
    <span class="kw">if</span> exists(Pattern(<img src="1439085105926.png" />).similar(<span class="dig">0.89</span>),<span class="dig">0</span>):
        <span class="skw">click</span>()
        Debug.user(<span class="str">"enable progress mode"</span>)
        <span class="kw">return</span> True
    <span class="kw">return</span> False

<span class="kw">def</span> buyUpgrades():
    <span class="kw">if</span> exists(Pattern(<img src="1439025589326.png" />).similar(<span class="dig">0.85</span>),<span class="dig">0</span>):
        <span class="skw">click</span>()
        <span class="kw">return</span> True
    <span class="kw">return</span> False

<span class="kw">def</span> scrollBottom():
    <span class="cmt"># Buy All Upgrades</span>
    <span class="kw">while</span> <span class="kw">not</span> exists(Pattern(<img src="1439025589326.png" />).similar(<span class="dig">0.85</span>), <span class="dig">0</span>):
        rest(<span class="dig">0.05</span>)
        <span class="cmt"># scroll up once to avoid getting stuck immediately after a new hero is available</span>
        <span class="kw">if</span> exists(Pattern(<img src="1439036427073.png" />).similar(<span class="dig">0.83</span>), <span class="dig">0</span>):
            <span class="skw">click</span>()
        <span class="cmt"># find scrollbar</span>
        <span class="kw">if</span> exists(Pattern(<img src="1439436060095.png" />).similar(<span class="dig">0.90</span>).targetOffset(<span class="dig">0</span>,-<span class="dig">13</span>), <span class="dig">0</span>):
            <span class="cmt"># scroll down</span>
            clickn(Pattern(<img src="1439436060095.png" />).similar(<span class="dig">0.90</span>).targetOffset(<span class="dig">0</span>,-<span class="dig">13</span>), <span class="dig">4</span>)

    <span class="skw">wait</span>(<span class="dig">0.20</span>)

<span class="kw">def</span> scrollTop():
    <span class="cmt"># find scroll bar at the top</span>
<span class="cmt">#    while not exists(Pattern("1439025863027.png").similar(0.80),0):</span>

    <span class="cmt"># click crossed swords</span>
    <span class="kw">if</span> exists(Pattern(<img src="1439025078984.png" />).similar(<span class="dig">0.90</span>)):
        Debug.user(<span class="str">"click crossed swords"</span>)
        <span class="skw">click</span>()
    <span class="kw">else</span>:
        Debug.user(<span class="str">"failed to scroll to the top, didn't find crossed swords"</span>)

<span class="kw">def</span> ascend():
    Debug.user(<span class="str">"ascending now"</span>)
    savedata = saveGame()
    save = decodeSave(savedata)

    collectedsouls = save[<span class="str">"primalSouls"</span>] - state[<span class="str">"primalSoulsStart"</span>]

    <span class="kw">for</span> k <span class="kw">in</span> [<span class="str">"primalSouls"</span>, <span class="str">"highestFinishedZone"</span>, <span class="str">"rubies"</span>, <span class="str">"totalHeroSouls"</span>, <span class="str">"currentZoneHeight"</span>]:
        Debug.user(<span class="str">"%s: %s"</span>%(k, save[k]))

    <span class="kw">if</span> checkrelics(save):
        <span class="cmt"># found a better relic than current, don't trash it, abort instead</span>
        Debug.user(<span class="str">"found better relic, not ascending"</span>)
        <span class="kw">return</span>

    <span class="cmt"># Relics</span>
    <span class="kw">if</span> exists(Pattern(<img src="1439100490944.png" />).similar(<span class="dig">0.80</span>),<span class="dig">1</span>):
        <span class="skw">click</span>()
        <span class="skw">wait</span>(<span class="dig">0.5</span>)
        <span class="cmt"># Salvage</span>
        <span class="kw">if</span> exists(<img src="1439155381793.png" />,<span class="dig">1</span>):
            <span class="skw">click</span>()
            <span class="skw">wait</span>(<span class="dig">0.5</span>)
            <span class="cmt"># Yes</span>
            <span class="kw">if</span> exists(Pattern(<img src="1439100607949.png" />).similar(<span class="dig">0.90</span>),<span class="dig">1</span>):
                <span class="skw">click</span>()

    scrollTop()

    <span class="cmt"># Amenhotep</span>
    findDown(Pattern(<img src="1439072160611.png" />).similar(<span class="dig">0.75</span>).targetOffset(-<span class="dig">74</span>,<span class="dig">57</span>), <span class="skw">click</span>, [])
    <span class="cmt"># Yes</span>
    <span class="kw">if</span> exists(Pattern(<img src="1439072311108.png" />).similar(<span class="dig">0.91</span>)):
        <span class="skw">click</span>()

    diffstr, diff = timediff(state[<span class="str">"starttime"</span>])

    rate = <span class="dig">0</span>
    <span class="kw">if</span> diff &gt; <span class="dig">0</span>:
        rate = collectedsouls / diff

    Debug.user(<span class="str">"Time for this run: %s rate: %f"</span> % (diffstr, rate))
    updateFromSave()

    <span class="kw">if</span> EXITASCEND:
        exit()

<span class="cmt"># find available dark ritual with energize etc</span>
<span class="kw">def</span> darkRitual():
    <span class="kw">if</span> exists(Pattern(<img src="1439478702484.png" />).similar(<span class="dig">0.90</span>)):
        <span class="kw">if</span> exists(Pattern(<img src="1439368983011.png" />).similar(<span class="dig">0.80</span>),<span class="dig">0</span>):
            Debug.user(<span class="str">"activate dark ritual"</span>)
            keyDown(<span class="str">'8'</span>)
            <span class="skw">wait</span>(<span class="dig">0.1</span>)
            keyUp(<span class="str">'8'</span>)
            <span class="skw">wait</span>(<span class="dig">0.1</span>)

            keyDown(<span class="str">'6'</span>)
            <span class="skw">wait</span>(<span class="dig">0.1</span>)
            keyUp(<span class="str">'6'</span>)
            <span class="skw">wait</span>(<span class="dig">0.1</span>)

            keyDown(<span class="str">'9'</span>)
            <span class="skw">wait</span>(<span class="dig">0.1</span>)
            keyUp(<span class="str">'9'</span>)
            <span class="skw">wait</span>(<span class="dig">0.1</span>)

<span class="cmt">###############</span>

<span class="kw">def</span> levelchange(event):
    state[<span class="str">'level'</span>] += <span class="dig">1</span>
    event.stopObserver()

<span class="cmt">###############</span>

<span class="kw">def</span> exithotkey(event):
    exit()

<span class="kw">def</span> ascendhotkey(event):
    state[<span class="str">"ascendNow"</span>] = True

<span class="kw">def</span> waithotkey(event):
    <span class="kw">if</span> <span class="str">"wait"</span> <span class="kw">in</span> state:
        state[<span class="str">"wait"</span>] = <span class="kw">not</span> state[<span class="str">"wait"</span>]

<span class="cmt">###############</span>

Env.addHotkey(Key.F1, KeyModifier.CTRL, exithotkey)
Env.addHotkey(Key.F2, KeyModifier.CTRL, ascendhotkey)
Env.addHotkey(Key.F3, KeyModifier.CTRL, waithotkey)

setShowActions(True)
Settings.UserLogs = True
Settings.UserLogPrefix = <span class="str">"user"</span>
Settings.UserLogTime = True
Settings.ObserveScanRate = <span class="dig">3</span>
Settings.MoveMouseDelay = <span class="dig">0.1</span>

<span class="kw">if</span> LOGFILEPATH:
    Debug.on(<span class="dig">2</span>)
    Debug.setLogFile(LOGFILEPATH)

<span class="cmt"># click the X</span>
<span class="kw">if</span> exists(Pattern(<img src="1439437994711.png" />).similar(<span class="dig">0.80</span>)):
    <span class="skw">click</span>()

<span class="cmt"># find top crossed swords to make the window active</span>
<span class="kw">if</span> exists(Pattern(<img src="1439025078984.png" />).similar(<span class="dig">0.90</span>)):
    <span class="skw">click</span>()
    r = getLastMatch()
    r.setX(r.getX() - <span class="dig">30</span>)
    r.setY(r.getY() - <span class="dig">100</span>)
    r.setH(r.getH() + <span class="dig">650</span>)
    r.setW(r.getW() + <span class="dig">1100</span>)
    setROI(r.getX(), r.getY(), r.getW(), r.getH())
    roi = Region(r.getX(), r.getY(), r.getW(), r.getH())
    Debug.user(<span class="str">"screenshot: %s"</span> % SCREEN.<span class="skw">capture</span>(roi))

resetstate()
save = updateFromSave()
state[<span class="str">"primalSoulsStart"</span>] = state[<span class="str">"primalSouls"</span>]

Debug.user(<span class="str">""</span>)
Debug.user(<span class="str">"Start"</span>)

<span class="kw">while</span> True:

    Debug.user(<span class="str">"Loop start: %s"</span> %state)

    <span class="kw">if</span> (state[<span class="str">"ascendSoon"</span>] <span class="kw">and</span> fish()) <span class="kw">or</span> state[<span class="str">"ascendNow"</span>]:
        Debug.user(<span class="str">"Ascend Now"</span>)
        ascend()
        rest(<span class="dig">2</span>)

    <span class="kw">if</span> state[<span class="str">"wait"</span>]:
        pos = Env.getMouseLocation()
        Debug.user(<span class="str">"Wait a while %s"</span>%(pos))
        <span class="skw">wait</span>(<span class="dig">1</span>)
        <span class="kw">continue</span>

    save = updateFromSave()

    <span class="cmt"># 0 DPS</span>
    <span class="kw">if</span> state[<span class="str">"hired"</span>] == <span class="dig">0</span>:
<span class="cmt">#    if exists(Pattern("1439111492693.png").similar(0.93),1):</span>
        Debug.user(<span class="str">"found 0 dps"</span>)

        <span class="skw">wait</span>(<span class="dig">1</span>)
        resetstate()
        state[<span class="str">"primalSoulsStart"</span>] = state[<span class="str">"primalSouls"</span>]

        <span class="kw">if</span> fish():
            Debug.user(<span class="str">"Found fish, waiting.."</span>)
            <span class="skw">wait</span>(<span class="dig">5</span>)
            Debug.user(<span class="str">"findDown samurai"</span>)
            findDown(Pattern(<img src="1439802146629.png" />).targetOffset(-<span class="dig">230</span>,<span class="dig">15</span>), zclick, [<span class="dig">100</span>])
        <span class="kw">else</span>:
            first = True

            <span class="kw">for</span> x <span class="kw">in</span> range(LEVELSKIP):
                <span class="cmt"># skip levels, next level arrow</span>
                clickn(Pattern(<img src="1439078366733.png" />), <span class="dig">18</span>)
                rest()
                <span class="cmt"># space next to next level arrow</span>
                clickn(Pattern(<img src="1439078366733.png" />).targetOffset(-<span class="dig">60</span>,<span class="dig">0</span>), <span class="dig">1</span>)

                <span class="cmt"># click next to shop</span>
                <span class="kw">if</span> first:
                    <span class="kw">if</span> exists(Pattern(<img src="1439022522525.png" />).similar(<span class="dig">0.85</span>).targetOffset(-<span class="dig">60</span>,<span class="dig">0</span>)):
                        clickn(getLastMatch(), <span class="dig">25</span>)
                        first = False

                Debug.user(<span class="str">"findDown samurai"</span>)
                findDown(Pattern(<img src="1439802146629.png" />).targetOffset(-<span class="dig">230</span>,<span class="dig">15</span>), zclick, [<span class="dig">20</span>])

                <span class="cmt"># necessary to wait a bit at each step in order to collect enough gold to progress</span>
                <span class="skw">wait</span>(<span class="dig">2</span>)

        progressMode()

    fish()
    darkRitual()

    <span class="kw">if</span> state[<span class="str">'samurai'</span>] &lt; SAMURAI:
        scrollTop()

        Debug.user(<span class="str">"findDown samurai"</span>)
        findDown(Pattern(<img src="1439802146629.png" />).targetOffset(-<span class="dig">230</span>,<span class="dig">15</span>), zclick, [<span class="dig">20</span>])

        scrollBottom()
        buyUpgrades()
        scrollTop()

        progressMode()

        <span class="kw">if</span> state[<span class="str">'samurai'</span>] &gt; SAMURAI / <span class="dig">2</span>:
            Debug.user(<span class="str">"findDown hire: %s"</span> %(state[<span class="str">'hired'</span>]))
            hired = state[<span class="str">'hired'</span>]
            <span class="kw">while</span> hired &lt; <span class="dig">26</span> <span class="kw">and</span> \
                    findDown(Pattern(<img src="1439151880109.png" />).similar(<span class="dig">0.90</span>), zclick, [<span class="dig">8</span>]):
                rest(<span class="dig">0.01</span>)

                hired += <span class="dig">1</span>

            Debug.user(<span class="str">"findDown hire done: %s"</span>% hired)

    <span class="kw">else</span>:
        <span class="cmt"># gilded</span>
        Debug.user(<span class="str">"look for gilded heroes"</span>)
        <span class="kw">if</span> findUp(Pattern(<img src="1439148729231.png" />).similar(<span class="dig">0.93</span>).targetOffset(<span class="dig">46</span>,<span class="dig">33</span>), zclick, [<span class="dig">10</span>]):
            <span class="kw">if</span> <span class="kw">not</span> state[<span class="str">"besthero"</span>]:
                r = getLastMatch()

                r.setX(r.getX() + <span class="dig">40</span>)
                r.setY(r.getY() + <span class="dig">140</span>)
                r.setH(<span class="dig">30</span>)
                r.setW(<span class="dig">100</span>)

                <span class="skw">wait</span>(<span class="dig">0.5</span>)
                hirebutton = Region(r.getX(), r.getY(), r.getW(), r.getH())

                <span class="kw">if</span> HIGHLIGHTS:
                    hirebutton.highlight()
                    <span class="skw">wait</span>(<span class="dig">2</span>)
                    hirebutton.highlight()

                rest()

                <span class="kw">try</span>:
                    hirebutton.<span class="skw">find</span>(Pattern(<img src="1439492761474.png" />).similar(<span class="dig">0.90</span>))
                    Debug.user(<span class="str">"failed to level best hero"</span>)
                    <span class="kw">if</span> exists(Pattern(<img src="1439031334204.png" />).similar(<span class="dig">0.85</span>).targetOffset(<span class="dig">16</span>,<span class="dig">11</span>)):
                        zclick(getLastMatch(), <span class="dig">10</span>)
                        Debug.user(<span class="str">"leveled secondary gilded hero"</span>)
                <span class="kw">except</span>:
                    Debug.user(<span class="str">"found hired best hero"</span>)
                    state[<span class="str">'besthero'</span>] = True
                    <span class="kw">pass</span>

        <span class="kw">else</span>:
            findUp(Pattern(<img src="1439031334204.png" />).similar(<span class="dig">0.85</span>).targetOffset(<span class="dig">16</span>,<span class="dig">11</span>), zclick, [<span class="dig">10</span>])
            Debug.user(<span class="str">"leveled secondary hero, didn't find primary"</span>)

        scrollBottom()
        buyUpgrades()

        Debug.user(<span class="str">"done with gild level up"</span>)

        <span class="cmt"># find inactive progression mode</span>
        <span class="kw">if</span> progressMode() <span class="kw">or</span> state[<span class="str">"highestFinishedZone"</span>] &gt; MAXZONE:
            state[<span class="str">"ascendSoon"</span>] = True
            Debug.user(<span class="str">"Ascend Soon"</span>)

    Debug.user(<span class="str">"Loop done: %s"</span> %(state))
</pre>
</body>
</html>
